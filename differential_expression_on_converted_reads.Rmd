---
title: "Differential Expression on Converted Reads"
author: "Maddie Lombardo"
date: "2/9/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(annotables)
library(PCAtools)
library(gprofiler2)
library(pcaExplorer)
library(AnnotationDbi)
library(org.Hs.eg.db)
library(clusterProfiler)
library(RColorBrewer)
```


This function will be organizing this data into 2 tables that can be input into a Deseq
I will be creating a table 1 that will act as the counts data frame that includes the gene and the min2 counts
Table 2 will act as the metadata for the deseq

```{r reading in file path}
grandslam_new_RNA_file_path <- file.path(here::here('data/grandslam_new_rna.csv'))

grandslam_new_rna <- read_csv(grandslam_new_RNA_file_path)
```

```{r filtering out any estimate new credible level > 20%}
grandslam_new_rna_filtered <- grandslam_new_rna %>% 
  filter(estimate_new_credible_interval < 0.2)
```

```{r filter 6 hr conversions}
filtered_6hr <- grandslam_new_rna_filtered %>% 
  filter(time == 6)
  
wider_6_hr_table <- filtered_6hr %>% 
  select(gene, min2, SampleID) %>% 
  mutate(min2 = round(min2)) %>% 
  pivot_wider(names_from = SampleID, values_from = min2, values_fill = 0)
```

```{r read in bayesian new ratio rna}
new_fraction_bayesian_file_path <- file.path(here::here('data/new_ratio_bayesian_p_de.csv'))

new_ratio_p_de <- read.csv(new_fraction_bayesian_file_path)
```

determining categories comparing new vs total rna's expression

```{r categorizing new vs total}
counts_by_hr <- new_ratio_p_de %>% 
  filter(!(total_rna_sig == 'not_significant' & new_rna_sig =='bdnf_equals_control')) %>% 
    group_by(time, new_rna_sig, total_rna_sig) %>% 
    filter(new_rna_sig != 'unclear') %>% 
    summarize(count = n())

counts_by_hr %>% 
    ggplot(aes(x = total_rna_sig, y = count, fill = new_rna_sig))+
    scale_fill_brewer(palette = "Paired")+
    geom_col() +
    facet_wrap(vars(time),scales = 'free_x')+
    coord_flip()+
    ggtitle("Categorizing New Vs. Total RNA") +
    labs(y = "Number of Genes per Timepoint", 
         x = "Total RNA Categorization",
         fill = "New RNA Levels with BDNF \nCompared to Control")+
  theme(axis.text.y = element_text(angle = 45), legend.position = "bottom", plot.title = element_text(hjust = 0.5), legend.text = element_text(size = 8), legend.title = element_text(size =10))
```


